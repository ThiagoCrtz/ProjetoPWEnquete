@model ProjetoPWEnquete.Models.Enquete

@{
    ViewData["Title"] = "Detalhes da Enquete";
}

<link rel="stylesheet" href="~/css/DetailsEnquete.css" />

<div class="details-container">
    <section class="details-box" aria-label="Detalhes da enquete">
        <h2>@Model.Question</h2>
        <p><strong>Descrição:</strong> @Model.descrição</p>
        <p><strong>Expira em:</strong> @Model.ExpiresAt.ToString("dd/MM/yyyy")</p>

        <h4>Escolha sua opção:</h4>
        <div class="options-container" role="list">
            @for (int i = 1; i <= 10; i++)
            {
                var optionText = (string)typeof(ProjetoPWEnquete.Models.Enquete)
                .GetProperty($"Option{i}")
                ?.GetValue(Model);

                if (!string.IsNullOrEmpty(optionText))
                {
                    <button type="button" class="option-btn" data-value="@i" role="listitem">@optionText</button>
                }
            }
        </div>

        <form method="post" asp-controller="Enquete" asp-action="Votar">
            @Html.AntiForgeryToken()
            <input type="hidden" name="EnqueteId" value="@Model.Id" />
            <input type="hidden" name="OpcaoSelecionada" id="OpcaoSelecionada" />

            <div class="btn-group mt-3">
                <button type="submit" id="btnVotar" class="btn btn-success" disabled>Votar</button>
                <a asp-controller="Enquete" asp-action="Grafico" asp-route-enqueteId="@Model.Id" class="btn btn-info">Ver Gráfico</a>
                <a asp-controller="Enquete" asp-action="ListarEnquetes" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </section>
</div>
<!-- Modal de Resposta -->
<div class="modal fade" id="modalVoto" tabindex="-1" aria-labelledby="modalVotoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalVotoLabel">Resultado da Votação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="modalVotoBody">
                <!-- Conteúdo da resposta será inserido aqui -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        const buttons = document.querySelectorAll('.option-btn');
        const btnVotar = document.getElementById('btnVotar');
        let selectedOption = null;

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedOption = btn.getAttribute('data-value');
                btnVotar.disabled = false;
                btnVotar.setAttribute('aria-disabled', 'false');
            });
        });

        btnVotar.addEventListener('click', async function (e) {
            e.preventDefault();

            const enqueteId = @Model.Id;
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const resposta = await fetch('/Enquete/Votar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({
                    EnqueteId: enqueteId,
                    OpcaoEscolhida: selectedOption
                })
            });

            const resultado = await resposta.text();
            document.getElementById('modalVotoBody').innerText = resultado;

            // Exibe o modal
            const modal = new bootstrap.Modal(document.getElementById('modalVoto'));
            modal.show();
        });
    </script>
}
