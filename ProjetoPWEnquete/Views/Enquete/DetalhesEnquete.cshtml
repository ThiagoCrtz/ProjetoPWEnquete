@model ProjetoPWEnquete.Models.Enquete
@{
    ViewData["Title"] = "Detalhes da Enquete";
}

<head>
    <link rel="stylesheet" href="~/css/DetailsEnquete.css" asp-append-version="true" />
</head>


<div class="details-container">
    <section class="details-box" aria-label="Detalhes da enquete">
        <h2>@Model.Question</h2>

        <div class="enquete-info">
            <div class="info-card">
                <div class="info-card-label">
                    <i class="bi bi-file-text"></i>
                    Descrição
                </div>
                <div class="info-card-value">@Model.descrição</div>
            </div>

            <div class="info-card">
                <div class="info-card-label">
                    <i class="bi bi-calendar-event"></i>
                    Expira em
                </div>
                <div class="info-card-value">@Model.ExpiresAt.ToString("dd/MM/yyyy")</div>
            </div>
        </div>

        <h4 class="section-title">Escolha sua opção</h4>

        <div class="options-container" role="list">
            @for (int i = 1; i <= 10; i++)
            {
                var optionText = (string)typeof(ProjetoPWEnquete.Models.Enquete)
                .GetProperty($"Option{i}")
                ?.GetValue(Model);
                if (!string.IsNullOrEmpty(optionText))
                {
                    <button type="button" class="option-btn" data-value="@i" role="listitem">
                        <span>@optionText</span>
                    </button>
                }
            }
        </div>

        <form method="post" asp-controller="Enquete" asp-action="Votar">
            @Html.AntiForgeryToken()
            <input type="hidden" name="EnqueteId" value="@Model.Id" />
            <input type="hidden" name="OpcaoSelecionada" id="OpcaoSelecionada" />

            <div class="btn-group">
                <button type="submit" id="btnVotar" class="btn btn-success" disabled>
                    <i class="bi bi-check-circle"></i>
                    <span>Confirmar Voto</span>
                </button>
                <a asp-controller="Enquete" asp-action="Grafico" asp-route-enqueteId="@Model.Id" class="btn btn-info">
                    <i class="bi bi-graph-up"></i>
                    <span>Ver Resultados</span>
                </a>
                <a asp-controller="Enquete" asp-action="ListarEnquetes" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i>
                    <span>Voltar</span>
                </a>
            </div>
        </form>
    </section>
</div>

<!-- Modal de Resposta -->
<div class="modal fade" id="modalVoto" tabindex="-1" aria-labelledby="modalVotoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalVotoLabel">Voto Confirmado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="modalVotoBody">
                <!-- Conteúdo da resposta será inserido aqui -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" data-bs-dismiss="modal">
                    <span>Fechar</span>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const buttons = document.querySelectorAll('.option-btn');
        const btnVotar = document.getElementById('btnVotar');
        let selectedOption = null;

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove seleção anterior
                buttons.forEach(b => b.classList.remove('selected'));

                // Adiciona seleção atual
                btn.classList.add('selected');
                selectedOption = btn.getAttribute('data-value');

                // Habilita botão de votar
                btnVotar.disabled = false;
                btnVotar.setAttribute('aria-disabled', 'false');
            });
        });

        btnVotar.addEventListener('click', async function (e) {
            e.preventDefault();

            if (!selectedOption) {
                alert('Por favor, selecione uma opção antes de votar.');
                return;
            }

            const enqueteId = @Model.Id;
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            try {
                const resposta = await fetch('/Enquete/Votar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify({
                        EnqueteId: enqueteId,
                        OpcaoEscolhida: selectedOption
                    })
                });

                const resultado = await resposta.text();
                document.getElementById('modalVotoBody').innerText = resultado;

                // Exibe o modal
                const modal = new bootstrap.Modal(document.getElementById('modalVoto'));
                modal.show();

                // Desabilita os botões após votar
                buttons.forEach(btn => btn.disabled = true);
                btnVotar.disabled = true;
            } catch (error) {
                console.error('Erro ao enviar voto:', error);
                alert('Ocorreu um erro ao processar seu voto. Tente novamente.');
            }
        });
    </script>
}